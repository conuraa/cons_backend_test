name: Deploy to Dev

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker image tag to deploy (default: latest)"
        required: false
        default: "latest"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to Dev Server
    runs-on: ubuntu-latest
    environment: development

    steps:
      - uses: actions/checkout@v4

      - name: Set image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          script: |
            set -e

            IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tag.outputs.tag }}"
            DEPLOY_DIR="$HOME/cons_backend_test"
            CONTAINER_NAME="cons_api_test"

            echo "=== Deploying $IMAGE ==="

            # Save current image for rollback
            CURRENT_IMAGE=$(docker inspect --format='{{.Config.Image}}' $CONTAINER_NAME 2>/dev/null || echo "none")
            echo "Current image: $CURRENT_IMAGE"

            # Pull new image
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull "$IMAGE"

            # Deploy
            cd "$DEPLOY_DIR"
            docker compose up -d

            # Health check
            echo "Waiting for health check..."
            sleep 10

            HEALTH_OK=false
            for i in 1 2 3; do
              if curl -sf http://localhost:7071/health > /dev/null 2>&1; then
                HEALTH_OK=true
                break
              fi
              echo "Health check attempt $i failed, retrying..."
              sleep 5
            done

            if [ "$HEALTH_OK" = "true" ]; then
              echo "=== Deploy successful ==="
            else
              echo "=== Health check failed! Rolling back ==="
              if [ "$CURRENT_IMAGE" != "none" ]; then
                docker compose down
                # Restore previous image
                sed -i "s|image:.*|image: $CURRENT_IMAGE|" docker-compose.yml
                docker compose up -d
                echo "=== Rolled back to $CURRENT_IMAGE ==="
              else
                docker compose down
                echo "=== No previous image to rollback to, stopped container ==="
              fi
              exit 1
            fi
